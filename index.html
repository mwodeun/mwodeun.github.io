<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MWODEUN 모든경매</title>
  <style>
    :root{
      --purple:#6a0dad;
      --purple2:#7c1dd1;
      --bg:#f5f5f5;
      --card:#ffffff;
      --muted:#666;
      --border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      background:var(--bg);
      color:#111;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      background:#fff;
      border-bottom:1px solid var(--border);
    }

    .bannerArea{
      background:#fff;
      border-bottom:1px solid rgba(0,0,0,.05);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:12px 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:260px;
    }
    .brand img{
      height:78px;
      width:auto;
      display:block;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.10));
    }
    .brand .title{
      font-weight:900;
      font-size:18px;
      line-height:1.1;
    }
    .brand .sub{
      font-size:12px;
      color:#1f2937;
      opacity:.85;
      margin-top:4px;
      font-weight:700;
    }

    .bannerMarquee{
      margin-top:8px;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      overflow:hidden;
    }
    .marqueeTrack{
      display:flex;
      width:100%;
      justify-content:center;
      overflow:hidden;
    }
    .marqueeText{
      display:inline-block;
      white-space:nowrap;
      font-weight:900;
      color:#111;
      opacity:.85;
      animation: marqueeLR 14s linear infinite;
    }
    @keyframes marqueeLR{
      0%{ transform: translateX(-55%); }
      100%{ transform: translateX(55%); }
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:320px;
      flex:1;
    }

    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
    }
    .chip label{
      font-size:12px;
      color:#111;
      opacity:.7;
      white-space:nowrap;
      font-weight:800;
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select{
      padding:8px 10px;
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      outline:none;
      background:#fff;
    }
    input[type="text"]{min-width:170px}
    select{min-width:120px}

    .btn{
      cursor:pointer;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
    }
    .btn.primary{background:var(--purple); color:#fff;}
    .btn.gray{background:#eee; color:#111;}
    .btn.danger{background:#d93025; color:#fff;}
    .btn.small{padding:7px 10px; border-radius:10px; font-size:12px}
    .btn.soft{background:#f3f0ff; color:#2b0a4a; border:1px solid rgba(106,13,173,.18);}
    .btn.soft:disabled{opacity:.5; cursor:not-allowed;}
    .btn.primary:disabled{opacity:.55; cursor:not-allowed;}

    .primaryNav{
      background: linear-gradient(90deg, var(--purple) 0%, var(--purple2) 100%);
      border-top:1px solid rgba(255,255,255,.18);
      border-bottom:1px solid rgba(0,0,0,.18);
    }
    .primaryNav .wrap{
      padding:8px 16px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .navLink{
      color:#fff;
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.08);
    }
    .navLink:hover{ background:rgba(255,255,255,.14); }

    .categoryRow{
      background:#fff;
      border-bottom:1px solid var(--border);
    }
    .categoryRow .wrap{
      padding:10px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .catBtn{
      cursor:pointer;
      border:1px solid var(--border);
      background:transparent;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      color:#111;
    }
    .catBtn.active{
      border-color:var(--purple);
      color:var(--purple);
      box-shadow:0 0 0 3px rgba(106,13,173,.08);
    }

    .adminPanel{
      display:none;
      margin-top:12px;
      padding:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:16px;
      box-shadow:0 10px 22px rgba(0,0,0,.08);
    }
    .adminGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .adminGrid .full{grid-column:1 / -1}

    main .wrap{padding:18px 16px 70px}
    h2{
      margin:24px 0 12px;
      font-size:20px;
    }
    .sectionHint{
      color:var(--muted);
      font-size:13px;
      margin-top:-6px;
      margin-bottom:14px;
    }

    .grid{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      justify-content:center;
    }
    .card{
      width:min(330px, 100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .card.closed{
      background:#e9e9e9;
      filter:grayscale(0.15);
    }
    .card .body{ padding:14px 14px 12px; }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(106,13,173,.1);
      color:var(--purple);
      border:1px solid rgba(106,13,173,.18);
      white-space:nowrap;
    }
    .badge.closed{
      background:rgba(0,0,0,.08);
      color:#222;
      border-color:rgba(0,0,0,.1);
    }
    .badge.bad{background:rgba(217,48,37,.10); color:#b42318; border-color:rgba(217,48,37,.25);}
    .badge.good{background:rgba(0,128,0,.10); color:#0f6a1a; border-color:rgba(0,128,0,.22);}
    .name{
      font-size:18px;
      font-weight:900;
      margin:8px 0 8px;
      word-break:keep-all;
    }
    .meta{
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
    }
    .price{
      margin-top:10px;
      font-size:16px;
      font-weight:900;
    }
    .price span{color:var(--purple)}
    .divider{
      height:1px;
      background:var(--border);
      margin:12px 0;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .bidBox{
      margin-top:10px;
      padding:10px;
      border:1px dashed rgba(106,13,173,.35);
      border-radius:12px;
      background:rgba(106,13,173,.04);
    }
    .bidHelp{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      line-height:1.35;
    }
    .smallText{font-size:12px; color:var(--muted)}
    .countdown{font-weight:900}
    .lastBidder{font-weight:900; color:#111;}

    .summaryBox{
      margin-top:22px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 8px 18px rgba(0,0,0,0.05);
      overflow:hidden;
    }
    .summaryHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
    }
    .summaryHead .ttl{
      font-size:18px;
      font-weight:900;
    }
    .summaryHead .hint{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .summaryGrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
    }
    .sumCol{
      padding:12px 12px 14px;
      min-height:140px;
      border-left:1px solid var(--border);
    }
    .sumCol:first-child{border-left:none;}
    .sumTitle{
      font-weight:900;
      margin-bottom:10px;
      color:#111;
    }
    .sumItem{
      padding:10px 8px;
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
      background:#fafafa;
      margin-bottom:10px;
    }
    .sumLine{
      font-size:12px;
      color:#111;
      line-height:1.45;
    }
    .sumLine b{font-weight:900;}
    .sumEmpty{
      font-size:12px;
      color:var(--muted);
      padding:6px 2px;
      font-weight:700;
    }
    @media (max-width:980px){
      .summaryGrid{ grid-template-columns: 1fr; }
      .sumCol{ border-left:none; border-top:1px solid var(--border); }
      .sumCol:first-child{ border-top:none; }
    }
    @media (max-width:720px){
      .adminGrid{grid-template-columns:1fr}
      input[type="text"]{min-width:140px}
      .brand{min-width:auto}
      .brand img{height:68px;}
    }
  </style>
</head>

<body>
  <header>
    <div class="bannerArea">
      <div class="wrap">
        <div class="topbar">
          <div class="brand">
            <img src="logo.png" alt="MWODEUN 모든경매" onerror="this.style.display='none'">
            <div>
              <div class="title">MWODEUN 모든경매</div>
              <div class="sub">중고 물품만 등록 · 시작가+마감시간+자동연장</div>
            </div>
          </div>

          <div class="controls">
            <div class="chip">
              <label>닉네임</label>
              <input id="nickname" type="text" placeholder="입찰 닉네임" />
            </div>

            <div class="chip">
              <label>자동 증가</label>
              <select id="incSelect">
                <option value="1000">+1,000원</option>
                <option value="5000">+5,000원</option>
                <option value="10000">+10,000원</option>
                <option value="50000">+50,000원</option>
              </select>
            </div>

            <button class="btn primary" onclick="toggleAdmin()">관리자 상품추가</button>
            <button class="btn gray" onclick="resetToSample()" title="샘플데이터로 초기화">샘플초기화</button>
          </div>
        </div>

        <div class="bannerMarquee">
          <div class="marqueeTrack">
            <div class="marqueeText" id="bannerText">
              MWODEUN 모든경매에 오신 것을 환영합니다 · 보증금 10,000원 계좌입금 후 입찰 · 낙찰 후 48시간 내 결제완료 · 거래완료(판매자+구매자) 확인 시 보증금 환불 · 미이행 시 보증금(판매자 8,000 / 플랫폼 2,000) 분배
            </div>
          </div>
        </div>

        <div class="adminPanel" id="adminPanel">
          <div class="adminGrid">
            <div>
              <div class="smallText">상품명</div>
              <input id="a_title" type="text" placeholder="예) 캠핑 테이블" />
            </div>
            <div>
              <div class="smallText">카테고리</div>
              <select id="a_category">
                <option value="가전">가전</option>
                <option value="공구/장비">공구/장비</option>
                <option value="전자스크랩">전자스크랩</option>
                <option value="생활용품/레저용품">생활용품/레저용품</option>
                <option value="건설 잔여자재">건설 잔여자재</option>
              </select>
            </div>

            <div>
              <div class="smallText">시작가(원)</div>
              <input id="a_startPrice" type="number" min="0" placeholder="예) 15000" />
            </div>
            <div>
              <div class="smallText">마감시간</div>
              <input id="a_endTime" type="datetime-local" />
            </div>

            <div class="full" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-start; margin-top:6px;">
              <button class="btn primary" onclick="adminSave()">등록/수정 저장</button>
              <button class="btn gray" onclick="adminClear()">입력칸 비우기</button>
              <span class="smallText" id="adminModeText">현재: 새 상품 등록 모드</span>
            </div>

            <div class="full" style="margin-top:8px;">
              <div class="smallText" style="font-weight:900; margin-bottom:6px;">보증금 입금 계좌(안내/기록용)</div>
              <div class="smallText" id="depositAccountText"></div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="primaryNav">
      <div class="wrap">
        <a class="navLink" href="#" onclick="return false;">HOME</a>
        <a class="navLink" href="#" onclick="return false;">회원가입</a>
        <a class="navLink" href="#" onclick="return false;">로그인</a>
        <a class="navLink" href="#" onclick="return false;">이용안내</a>
        <a class="navLink" href="#" onclick="return false;">고객센터</a>
      </div>
    </div>

    <div class="categoryRow">
      <div class="wrap" id="categoryBar"></div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <h2>진행중 경매</h2>
      <div class="sectionHint">
        마감시간이 지나면 자동으로 “마감 카드”로 이동합니다. (LocalStorage 저장됨)
        <br>※ 데모 모드에서는 진행중 카드가 최소 3개 유지되도록 자동 생성됩니다.
      </div>
      <div class="grid" id="openGrid"></div>

      <div id="closedSection" style="display:none;">
        <h2 style="margin-top:42px;">마감 카드</h2>
        <div class="sectionHint">마감된 상품만 이곳에 모입니다. (결제/거래완료/미이행 처리 후 자동으로 화면에서 숨김)</div>
        <div class="grid" id="closedGrid"></div>
      </div>

      <div class="summaryBox" id="summaryBox">
        <div class="summaryHead">
          <div class="ttl">진행중인 경매</div>
          <div class="hint">카테고리별 “상품명 / 현재가 / 남은시간”</div>
        </div>
        <div class="summaryGrid" id="summaryGrid"></div>
      </div>

    </div>
  </main>

  <script>
    /***********************
     * 표시 개수/데모 채움(원장호님 요청)
     ***********************/
    const UI_LIMITS = {
      // 진행중 카드가 최소 몇 개 유지?
      MIN_OPEN_CARDS: 3,

      // 화면에 최대 몇 개까지 보여줄지(너무 길어지는 것 방지)
      MAX_OPEN_SHOW: 12,
      MAX_CLOSED_SHOW: 12,

      // ✅ 데모/테스트용 자동 채움 ON/OFF (원하면 false로 바꾸면 끝)
      DEMO_FILL_OPEN: true,

      // ✅ 거래가 끝난 마감카드(환불완료/미이행완료)는 화면에서 숨김
      HIDE_FINISHED_CLOSED: true
    };

    /***********************
     * 규칙(원장호님 확정)
     ***********************/
    const RULES = {
      depositAmount: 10000,
      nonPaymentHours: 48,
      penalty: { seller: 8000, platform: 2000 },
      sanctions: { warnAt: 1, suspendAt: 2, suspendDays: 30, banAt: 3 }
    };

    const DEPOSIT_ACCOUNT = {
      bank: "농협",
      number: "000-0000-0000-00",
      name: "MWODEUN(예치금)"
    };

    /***********************
     * LocalStorage Keys
     ***********************/
    const LS_KEY_NEW = "mwodeun_products_rules_v3";
    const LS_KEY_PREV = "mwodeun_products_rules_v2";
    const LS_KEY_OLD  = "mwodeun_products_final_v1";
    const LS_FILTER = "mwodeun_filter_final_v1";
    const LS_USERS  = "mwodeun_users_rules_v2";
    const LS_LEDGER = "mwodeun_ledger_rules_v2";

    function nowISO(){ return new Date().toISOString(); }
    function formatMoney(n){ return Number(n||0).toLocaleString("ko-KR"); }

    function toLocalInputValue(date){
      const pad = n => String(n).padStart(2,'0');
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function cryptoRandomId(){
      return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function calcRemain(endIso){
      const end = new Date(endIso).getTime();
      const now = Date.now();
      const diff = end - now;
      if (isNaN(end)) return {closed:false, text:"시간정보 없음"};
      if (diff <= 0) return {closed:true, text:"마감"};
      const sec = Math.floor(diff/1000);
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return {closed:false, text:`${h}시간 ${m}분 ${s}초`};
    }
    function calcRemainFromMs(targetMs){
      const now = Date.now();
      const diff = targetMs - now;
      if (diff <= 0) return {over:true, text:"기한 만료"};
      const sec = Math.floor(diff/1000);
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return {over:false, text:`${h}시간 ${m}분 ${s}초`};
    }
    function formatEndTime(iso){
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "시간정보 없음";
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ` +
             `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    /***********************
     * Users(Sanctions)
     ***********************/
    function loadUsers(){
      try{
        const raw = localStorage.getItem(LS_USERS);
        if(!raw) return {};
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== "object") return {};
        return parsed;
      }catch(e){ return {}; }
    }
    function saveUsers(users){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
    function getUser(users, nick){
      if(!users[nick]){
        users[nick] = { nick, strikes:0, suspendedUntil:0, banned:false, createdAt: nowISO() };
      }
      return users[nick];
    }
    function userStatusText(u){
      if(u.banned) return "영구정지";
      if(u.suspendedUntil && u.suspendedUntil > Date.now()){
        const remain = calcRemainFromMs(u.suspendedUntil);
        return `정지중(${remain.text})`;
      }
      if(u.strikes >= 1) return `경고/누적 ${u.strikes}`;
      return "정상";
    }
    function canBid(u){
      if(u.banned) return {ok:false, msg:"영구정지 상태라 입찰할 수 없습니다."};
      if(u.suspendedUntil && u.suspendedUntil > Date.now()){
        return {ok:false, msg:"정지 기간 중에는 입찰할 수 없습니다."};
      }
      return {ok:true, msg:"OK"};
    }

    /***********************
     * Ledger
     ***********************/
    function loadLedger(){
      try{
        const raw = localStorage.getItem(LS_LEDGER);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return [];
        return parsed;
      }catch(e){ return []; }
    }
    function saveLedger(arr){ localStorage.setItem(LS_LEDGER, JSON.stringify(arr)); }
    function ledgerAdd(type, payload){
      const ledger = loadLedger();
      ledger.unshift({ id: cryptoRandomId(), type, at: nowISO(), ...payload });
      saveLedger(ledger);
    }

    /***********************
     * Products Load/Migrate
     ***********************/
    function normalizeProduct(p){
      const n = {...p};
      n.id = n.id || cryptoRandomId();
      n.title = n.title || "-";
      n.category = n.category || "가전";
      n.startPrice = Number(n.startPrice || 0);
      n.currentPrice = Number(n.currentPrice || n.startPrice || 0);
      n.endTime = n.endTime || new Date(Date.now()+3600*1000).toISOString();
      n.highestBidder = n.highestBidder || "";
      n.bidCount = Number(n.bidCount || 0);
      n.createdAt = n.createdAt || nowISO();
      n.closed = !!n.closed;

      n.winnerNick = n.winnerNick || "";
      n.winnerFinalPrice = Number(n.winnerFinalPrice || 0);
      n.closedAt = n.closedAt || "";
      n.payDueAt = Number(n.payDueAt || 0);
      n.buyerPaid = !!n.buyerPaid;
      n.sellerConfirmed = !!n.sellerConfirmed;
      n.depositHeld = (n.depositHeld === undefined) ? false : !!n.depositHeld;
      n.depositRefunded = !!n.depositRefunded;
      n.depositForfeited = !!n.depositForfeited;
      n.defaulted = !!n.defaulted;
      n.defaultedAt = n.defaultedAt || "";
      n.defaultReason = n.defaultReason || "";

      // ✅ 거래가 끝난 마감카드를 숨기기 위한 아카이브 플래그
      n.archived = !!n.archived;

      // ✅ 데모 자동 생성 여부(나중에 구분하기 위함)
      n.isDemo = !!n.isDemo;

      return n;
    }

    function loadProducts(){
      const tryKeys = [LS_KEY_NEW, LS_KEY_PREV, LS_KEY_OLD];
      for(const k of tryKeys){
        const raw = localStorage.getItem(k);
        if(!raw) continue;
        try{
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)){
            const normalized = parsed.map(normalizeProduct);
            localStorage.setItem(LS_KEY_NEW, JSON.stringify(normalized));
            return normalized;
          }
        }catch(e){}
      }
      return null;
    }
    function saveProducts(){ localStorage.setItem(LS_KEY_NEW, JSON.stringify(state.products)); }

    function seedSample(){
      const base = new Date();
      const plusMin = (min)=> new Date(base.getTime() + min*60*1000);
      return [
        normalizeProduct({ id: cryptoRandomId(), title:"전동드릴 세트", category:"공구/장비", startPrice:15000, currentPrice:15000,
          endTime: plusMin(180).toISOString(), highestBidder:"", bidCount:0, createdAt: nowISO(), closed:false }),
        normalizeProduct({ id: cryptoRandomId(), title:"LG 55인치 TV (고장)", category:"가전", startPrice:15000, currentPrice:15000,
          endTime: plusMin(90).toISOString(), highestBidder:"", bidCount:0, createdAt: nowISO(), closed:false }),
        normalizeProduct({ id: cryptoRandomId(), title:"캠핑 테이블", category:"생활용품/레저용품", startPrice:15000, currentPrice:15000,
          endTime: plusMin(15).toISOString(), highestBidder:"", bidCount:0, createdAt: nowISO(), closed:false })
      ];
    }

    const state = { products: [], filterCategory: "전체", adminEditingId: null };

    function loadFilter(){
      const raw = localStorage.getItem(LS_FILTER);
      if(raw) state.filterCategory = raw;
    }
    function saveFilter(){ localStorage.setItem(LS_FILTER, state.filterCategory); }

    /***********************
     * Close finalize
     ***********************/
    function onCloseFinalize(p){
      if(p.closedAt) return;
      p.closedAt = nowISO();
      p.winnerNick = p.highestBidder || "";
      p.winnerFinalPrice = Number(p.currentPrice || p.startPrice || 0);

      const closedMs = new Date(p.closedAt).getTime();
      p.payDueAt = closedMs + RULES.nonPaymentHours * 60 * 60 * 1000;

      if(p.winnerNick){
        p.depositHeld = true;
        ledgerAdd("DEPOSIT_HELD", { productId:p.id, title:p.title, nick:p.winnerNick, amount:RULES.depositAmount, note:"낙찰 시 보증금 예치(기록)" });
      }
    }

    function syncClosedFlags(){
      const now = Date.now();
      state.products.forEach(p=>{
        const end = new Date(p.endTime).getTime();
        if(!isNaN(end) && end <= now){
          if(!p.closed) p.closed = true;
          onCloseFinalize(p);
        }
      });
    }

    /***********************
     * Auto default after 48h
     ***********************/
    function applyDefault(p){
      if(!p.closed) return;
      if(p.defaulted) return;
      if(!p.winnerNick) return;
      if(p.buyerPaid) return;
      if(!p.payDueAt) return;

      if(Date.now() > p.payDueAt){
        p.defaulted = true;
        p.defaultedAt = nowISO();
        p.defaultReason = "낙찰 후 48시간 내 결제완료 미이행";

        if(p.depositHeld && !p.depositForfeited && !p.depositRefunded){
          p.depositForfeited = true;
          p.depositHeld = false;
          ledgerAdd("DEPOSIT_FORFEIT", {
            productId:p.id, title:p.title, nick:p.winnerNick,
            amount:RULES.depositAmount, distribution:RULES.penalty,
            note:"미이행으로 보증금 몰수(판매자 8,000 / 플랫폼 2,000)"
          });
        }

        const users = loadUsers();
        const u = getUser(users, p.winnerNick);
        u.strikes += 1;

        if(u.strikes >= RULES.sanctions.banAt){
          u.banned = true;
          u.suspendedUntil = 0;
        }else if(u.strikes >= RULES.sanctions.suspendAt){
          u.suspendedUntil = Date.now() + RULES.sanctions.suspendDays * 24 * 60 * 60 * 1000;
        }
        saveUsers(users);

        ledgerAdd("SANCTION", { nick:p.winnerNick, strikes:u.strikes, status:userStatusText(u), productId:p.id, title:p.title, note:"미이행 제재 적용" });
      }
    }

    /***********************
     * Buyer/Seller complete -> refund
     ***********************/
    function maybeRefund(p){
      if(!p.buyerPaid) return;
      if(!p.sellerConfirmed) return;
      if(p.depositRefunded) return;
      if(p.depositForfeited) return;
      if(!p.winnerNick) return;

      if(p.depositHeld) p.depositHeld = false;
      p.depositRefunded = true;

      ledgerAdd("DEPOSIT_REFUND", { productId:p.id, title:p.title, nick:p.winnerNick, amount:RULES.depositAmount, note:"거래완료 확인으로 보증금 환불" });
    }

    function markBuyerPaid(productId){
      const nick = (document.getElementById("nickname").value || "").trim();
      if(!nick){ alert("닉네임을 입력해주세요."); return; }

      const p = state.products.find(x=>x.id===productId);
      if(!p) return;
      if(!p.closed){ alert("아직 마감되지 않았습니다."); return; }
      if(!p.winnerNick){ alert("낙찰자가 없습니다."); return; }
      if(nick !== p.winnerNick){ alert("결제완료는 낙찰자 닉네임으로만 가능합니다."); return; }
      if(p.defaulted){ alert("이미 미이행 처리된 건입니다."); return; }

      p.buyerPaid = true;
      ledgerAdd("BUYER_PAID", { productId:p.id, title:p.title, nick:p.winnerNick, price:p.winnerFinalPrice, note:"구매자 결제완료" });

      saveProducts();
      renderAll();
    }

    function markSellerConfirm(productId){
      const p = state.products.find(x=>x.id===productId);
      if(!p) return;
      if(!p.closed){ alert("아직 마감되지 않았습니다."); return; }
      if(!p.winnerNick){ alert("낙찰자가 없습니다."); return; }
      if(p.defaulted){ alert("미이행 처리된 건은 거래완료가 불가합니다."); return; }

      p.sellerConfirmed = true;
      ledgerAdd("SELLER_CONFIRMED", { productId:p.id, title:p.title, nick:p.winnerNick, note:"판매자 거래완료 확인" });

      maybeRefund(p);
      saveProducts();
      renderAll();
    }

    /***********************
     * ✅ 거래 종료된 마감카드 자동 숨김(아카이브)
     ***********************/
    function archiveFinishedClosed(p){
      if(!UI_LIMITS.HIDE_FINISHED_CLOSED) return;

      // "거래가 끝남" 정의:
      // 1) 환불완료(거래완료) 또는 2) 미이행 처리 완료
      const finished = (p.depositRefunded === true) || (p.defaulted === true);
      if(p.closed && finished && !p.archived){
        p.archived = true;
        ledgerAdd("ARCHIVE", { productId:p.id, title:p.title, note:"거래 종료로 화면에서 숨김(아카이브)" });
      }
    }

    /***********************
     * Categories
     ***********************/
    const CATEGORIES = ["전체","가전","공구/장비","전자스크랩","생활용품/레저용품","건설 잔여자재"];
    function renderCategoryBar(){
      const bar = document.getElementById("categoryBar");
      bar.innerHTML = "";
      CATEGORIES.forEach(cat=>{
        const btn = document.createElement("button");
        btn.className = "catBtn" + (state.filterCategory===cat ? " active":"");
        btn.textContent = cat;
        btn.onclick = ()=>{
          state.filterCategory = cat;
          saveFilter();
          renderAll();
        };
        bar.appendChild(btn);
      });
    }
    function passFilter(p){
      if(state.filterCategory === "전체") return true;
      return p.category === state.filterCategory;
    }

    /***********************
     * Bidding
     ***********************/
    function doBid(productId){
      const nick = (document.getElementById("nickname").value || "").trim();
      if(!nick){
        alert("닉네임을 먼저 입력해주세요.");
        document.getElementById("nickname").focus();
        return;
      }

      const users = loadUsers();
      const u = getUser(users, nick);
      const ok = canBid(u);
      if(!ok.ok){
        alert(ok.msg + `\n\n현재 상태: ${userStatusText(u)}`);
        return;
      }
      saveUsers(users);

      const p = state.products.find(x=>x.id===productId);
      if(!p) return;

      syncClosedFlags();
      if(p.closed){
        alert("이미 마감된 상품입니다.");
        renderAll();
        return;
      }

      const chk = document.getElementById("dep_"+productId);
      if(!chk || !chk.checked){
        alert(`입찰보증금(${formatMoney(RULES.depositAmount)}원) 확인 체크 후 입찰할 수 있습니다.\n\n입금 계좌: ${DEPOSIT_ACCOUNT.bank} ${DEPOSIT_ACCOUNT.number} (${DEPOSIT_ACCOUNT.name})`);
        return;
      }

      const inc = Number(document.getElementById("incSelect").value || 1000);
      const next = Number(p.currentPrice || p.startPrice || 0) + inc;

      // auto extend if within 60s
      const endMs = new Date(p.endTime).getTime();
      const now = Date.now();
      if(!isNaN(endMs)){
        const remainSec = Math.floor((endMs - now)/1000);
        if(remainSec > 0 && remainSec <= 60){
          p.endTime = new Date(now + 60*1000).toISOString();
        }
      }

      p.currentPrice = next;
      p.highestBidder = nick;
      p.bidCount = Number(p.bidCount || 0) + 1;

      saveProducts();
      renderAll();
    }

    /***********************
     * Admin
     ***********************/
    function toggleAdmin(){
      const panel = document.getElementById("adminPanel");
      panel.style.display = (panel.style.display === "block") ? "none" : "block";
    }
    function adminClear(){
      state.adminEditingId = null;
      document.getElementById("a_title").value = "";
      document.getElementById("a_category").value = "가전";
      document.getElementById("a_startPrice").value = "";
      document.getElementById("a_endTime").value = "";
      document.getElementById("adminModeText").textContent = "현재: 새 상품 등록 모드";
    }
    function adminEdit(id){
      const p = state.products.find(x=>x.id===id);
      if(!p) return;

      state.adminEditingId = id;
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("a_title").value = p.title || "";
      document.getElementById("a_category").value = p.category || "가전";
      document.getElementById("a_startPrice").value = Number(p.startPrice || 0);
      document.getElementById("a_endTime").value = toLocalInputValue(new Date(p.endTime));
      document.getElementById("adminModeText").textContent = "현재: 수정 모드 (저장하면 해당 상품이 수정됩니다)";
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function adminDelete(id){
      if(!confirm("정말 삭제하시겠습니까?")) return;
      state.products = state.products.filter(x=>x.id!==id);
      saveProducts();
      renderAll();
    }
    function adminSave(){
      const title = (document.getElementById("a_title").value || "").trim();
      const category = document.getElementById("a_category").value;
      const startPrice = Number(document.getElementById("a_startPrice").value || 0);
      const endLocal = document.getElementById("a_endTime").value;

      if(!title){ alert("상품명을 입력하세요."); return; }
      if(!startPrice || startPrice < 0){ alert("시작가를 올바르게 입력하세요."); return; }
      if(!endLocal){ alert("마감시간을 선택하세요."); return; }

      const endIso = new Date(endLocal).toISOString();

      if(state.adminEditingId){
        const p = state.products.find(x=>x.id===state.adminEditingId);
        if(!p) return;

        p.title = title;
        p.category = category;
        p.startPrice = startPrice;
        if(Number(p.currentPrice || 0) < startPrice) p.currentPrice = startPrice;
        p.endTime = endIso;

        // 마감시간이 미래면 다시 진행중 가능
        if(new Date(p.endTime).getTime() > Date.now()){
          p.closed = false;
          p.archived = false;
        }
      }else{
        state.products.unshift(normalizeProduct({
          id: cryptoRandomId(),
          title, category,
          startPrice,
          currentPrice: startPrice,
          endTime: endIso,
          highestBidder:"",
          bidCount:0,
          createdAt: nowISO(),
          closed:false,
          isDemo:false
        }));
      }

      saveProducts();
      adminClear();
      renderAll();
    }

    /***********************
     * ✅ 데모용 진행중 카드 자동 채움(최소 3개)
     ***********************/
    const DEMO_NAMES = ["랜덤 공구 박스", "중고 모니터(테스트)", "선풍기(테스트)", "드릴 배터리", "건설자재 잔량", "생활용품 묶음"];
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function createDemoProduct(){
      const baseMin = 20 + Math.floor(Math.random()*140); // 20~160분
      const end = new Date(Date.now() + baseMin*60*1000).toISOString();
      const cat = pick(["가전","공구/장비","전자스크랩","생활용품/레저용품","건설 잔여자재"]);
      const price = pick([12000,15000,18000,20000,25000]);

      return normalizeProduct({
        id: cryptoRandomId(),
        title: pick(DEMO_NAMES),
        category: cat,
        startPrice: price,
        currentPrice: price,
        endTime: end,
        highestBidder:"",
        bidCount:0,
        createdAt: nowISO(),
        closed:false,
        isDemo:true
      });
    }

    function ensureMinOpenCards(){
      if(!UI_LIMITS.DEMO_FILL_OPEN) return;

      // 아카이브 제외하고 실제 화면 기준 진행중 개수
      const open = state.products.filter(p=>!p.closed && !p.archived);
      let need = UI_LIMITS.MIN_OPEN_CARDS - open.length;
      if(need <= 0) return;

      // 부족한 만큼 데모 상품 추가
      for(let i=0;i<need;i++){
        state.products.unshift(createDemoProduct());
      }
      saveProducts();
    }

    /***********************
     * Render cards
     ***********************/
    function renderCard(p){
      const remain = calcRemain(p.endTime);
      const closed = p.closed || remain.closed;

      if(closed){
        if(!p.closed) p.closed = true;
        onCloseFinalize(p);
        applyDefault(p);
        archiveFinishedClosed(p);
      }

      const card = document.createElement("div");
      card.className = "card" + (closed ? " closed":"");

      // status badge
      let badgeClass = closed ? "badge closed" : "badge";
      let badgeText = closed ? "마감" : "진행중";

      if(closed && p.defaulted){
        badgeClass = "badge bad";
        badgeText = "미이행";
      }else if(closed && p.depositRefunded){
        badgeClass = "badge good";
        badgeText = "거래완료";
      }else if(closed && p.buyerPaid){
        badgeClass = "badge good";
        badgeText = "결제완료";
      }

      const badge = document.createElement("div");
      badge.className = badgeClass;
      badge.textContent = badgeText;

      const topRow = document.createElement("div");
      topRow.className = "row";
      topRow.appendChild(badge);

      const cat = document.createElement("div");
      cat.className = "smallText";
      cat.style.fontWeight = "900";
      cat.textContent = p.category || "-";
      topRow.appendChild(cat);

      const body = document.createElement("div");
      body.className = "body";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.title || "-";

      const meta = document.createElement("div");
      meta.className = "meta";

      if(!closed){
        const bidderText = p.highestBidder ? `<span class="lastBidder">${escapeHtml(p.highestBidder)}</span>` : "-";
        meta.innerHTML =
          `마감: <span class="countdown" id="cd_${p.id}">${remain.text}</span><br>` +
          `마감시간: ${formatEndTime(p.endTime)}<br>` +
          `입찰자: ${bidderText} / 입찰횟수: <b id="bc_${p.id}">${Number(p.bidCount||0)}</b>회`;
      }else{
        const winner = p.winnerNick ? `<span class="lastBidder">${escapeHtml(p.winnerNick)}</span>` : "-";
        const due = p.payDueAt ? calcRemainFromMs(p.payDueAt) : {over:false, text:"-"};
        const dueText = p.winnerNick ? (due.over ? "기한 만료" : due.text) : "-";
        meta.innerHTML =
          `마감시간: ${formatEndTime(p.endTime)}<br>` +
          `낙찰자: ${winner} / 낙찰가: <b>${formatMoney(p.winnerFinalPrice || p.currentPrice || p.startPrice)}</b>원<br>` +
          `결제기한(48H): <b id="due_${p.id}">${dueText}</b>`;
        if(p.defaulted){
          meta.innerHTML += `<br><span style="color:#b42318; font-weight:900;">사유: ${escapeHtml(p.defaultReason || "미이행")}</span>`;
        }
      }

      const price = document.createElement("div");
      price.className = "price";
      price.innerHTML = `현재가: <span id="cp_${p.id}">${formatMoney(p.currentPrice || p.startPrice)}</span>원`;

      const divider = document.createElement("div");
      divider.className = "divider";

      const actions = document.createElement("div");
      actions.className = "actions";

      const leftBox = document.createElement("div");
      leftBox.style.display = "flex";
      leftBox.style.gap = "8px";
      leftBox.style.flexWrap = "wrap";

      const adminArea = document.createElement("div");
      adminArea.style.display="flex";
      adminArea.style.gap="8px";

      const editBtn = document.createElement("button");
      editBtn.className = "btn gray small";
      editBtn.textContent = "수정";
      editBtn.onclick = ()=>adminEdit(p.id);

      const delBtn = document.createElement("button");
      delBtn.className = "btn danger small";
      delBtn.textContent = "삭제";
      delBtn.onclick = ()=>adminDelete(p.id);

      adminArea.appendChild(editBtn);
      adminArea.appendChild(delBtn);

      if(!closed){
        const bidBtn = document.createElement("button");
        bidBtn.className = "btn primary";
        bidBtn.textContent = "입찰하기";
        bidBtn.onclick = ()=>doBid(p.id);
        leftBox.appendChild(bidBtn);
      }else{
        const buyerPaidBtn = document.createElement("button");
        buyerPaidBtn.className = "btn primary";
        buyerPaidBtn.textContent = p.buyerPaid ? "결제완료됨" : "결제완료(구매자)";
        buyerPaidBtn.disabled = p.buyerPaid || p.defaulted || !p.winnerNick;
        buyerPaidBtn.onclick = ()=>markBuyerPaid(p.id);

        const sellerBtn = document.createElement("button");
        sellerBtn.className = "btn soft";
        sellerBtn.textContent = p.sellerConfirmed ? "판매자확인됨" : "거래완료 확인(판매자)";
        sellerBtn.disabled = p.sellerConfirmed || p.defaulted || !p.winnerNick;
        sellerBtn.onclick = ()=>markSellerConfirm(p.id);

        leftBox.appendChild(buyerPaidBtn);
        leftBox.appendChild(sellerBtn);
      }

      actions.appendChild(leftBox);
      actions.appendChild(adminArea);

      const bidBox = document.createElement("div");
      bidBox.className = "bidBox";

      if(!closed){
        const inc = Number(document.getElementById("incSelect").value || 1000);
        const next = Number(p.currentPrice || p.startPrice || 0) + inc;

        bidBox.innerHTML = `
          <div class="row" style="gap:10px; flex-wrap:wrap; justify-content:flex-start;">
            <label style="display:flex; align-items:center; gap:8px; font-weight:900; cursor:pointer;">
              <input type="checkbox" id="dep_${p.id}">
              입찰보증금(${formatMoney(RULES.depositAmount)}원) 확인
            </label>
            <div class="smallText" style="font-weight:900;">
              다음 입찰가: <span id="nb_${p.id}">${formatMoney(next)}</span>원
            </div>
          </div>
          <div class="bidHelp">
            • 입금계좌: <b>${DEPOSIT_ACCOUNT.bank} ${DEPOSIT_ACCOUNT.number}</b> (${DEPOSIT_ACCOUNT.name})<br>
            • 닉네임 + 보증금 체크 후 “입찰하기” 누르면 자동 증가합니다.<br>
            • 마감 60초 이내 입찰 시 자동연장(60초) 적용.
          </div>
        `;
      }else{
        const depositState =
          p.depositRefunded ? "환불 완료" :
          p.depositForfeited ? "몰수(판매자/플랫폼 분배)" :
          p.depositHeld ? "예치 중" : "-";

        bidBox.innerHTML = `
          <div class="bidHelp">
            • 보증금 상태: <b>${depositState}</b> (금액: ${formatMoney(RULES.depositAmount)}원)<br>
            • 낙찰 후 48시간 내 결제완료 없으면 자동 “미이행” 처리됩니다.<br>
            • 거래완료(구매자 결제완료 + 판매자 확인) 시 보증금 환불 처리(기록).
          </div>
        `;
      }

      body.appendChild(topRow);
      body.appendChild(name);
      body.appendChild(meta);
      body.appendChild(price);
      body.appendChild(divider);
      body.appendChild(actions);
      body.appendChild(bidBox);

      card.appendChild(body);
      return card;
    }

    function updateNextBidLabels(){
      const inc = Number(document.getElementById("incSelect").value || 1000);
      state.products.forEach(p=>{
        const el = document.getElementById("nb_"+p.id);
        if(!el) return;
        const next = Number(p.currentPrice || p.startPrice || 0) + inc;
        el.textContent = formatMoney(next);
      });
    }

    /***********************
     * Summary
     ***********************/
    const SUMMARY_CATS = [
      {key:"가전", label:"가전"},
      {key:"공구/장비", label:"공구/장비"},
      {key:"전자스크랩", label:"전자스크랩"},
      {key:"생활용품/레저용품", label:"생활용품/레저용품"},
      {key:"건설 잔여자재", label:"건설 전여자재"}
    ];

    function renderSummary(openItems){
      const grid = document.getElementById("summaryGrid");
      grid.innerHTML = "";

      SUMMARY_CATS.forEach(cat=>{
        const col = document.createElement("div");
        col.className = "sumCol";

        const t = document.createElement("div");
        t.className = "sumTitle";
        t.textContent = cat.label;

        col.appendChild(t);

        const list = openItems.filter(p=>p.category===cat.key);

        if(list.length===0){
          const empty = document.createElement("div");
          empty.className = "sumEmpty";
          empty.textContent = "등록된 상품이 없습니다.";
          col.appendChild(empty);
        }else{
          list.slice(0, 6).forEach(p=>{
            const remain = calcRemain(p.endTime);
            const box = document.createElement("div");
            box.className = "sumItem";
            box.innerHTML = `
              <div class="sumLine"><b>상품명:</b> ${escapeHtml(p.title)}</div>
              <div class="sumLine"><b>현재가:</b> ${formatMoney(p.currentPrice || p.startPrice)}원</div>
              <div class="sumLine"><b>남은시간:</b> <span id="sum_cd_${p.id}">${remain.text}</span></div>
            `;
            col.appendChild(box);
          });
        }

        grid.appendChild(col);
      });
    }

    /***********************
     * Render All (with limits + archive + ensure 3 open)
     ***********************/
    function renderAll(){
      syncClosedFlags();

      // 마감 카드 후처리/아카이브
      state.products.forEach(p=>{
        if(p.closed){
          applyDefault(p);
          maybeRefund(p);
          archiveFinishedClosed(p);
        }
      });

      // ✅ 진행중 최소 3개 채우기(데모용)
      ensureMinOpenCards();

      renderCategoryBar();

      const openGrid = document.getElementById("openGrid");
      const closedGrid = document.getElementById("closedGrid");
      openGrid.innerHTML = "";
      closedGrid.innerHTML = "";

      // 화면에서 아카이브는 제외
      const visible = state.products.filter(p=>!p.archived);

      const filtered = visible.filter(passFilter);

      // 진행중/마감 분리
      let open = filtered.filter(p=>!p.closed);
      let closed = filtered.filter(p=>p.closed);

      // ✅ 표시 최대 개수 제한
      open = open.slice(0, UI_LIMITS.MAX_OPEN_SHOW);

      // ✅ 마감은 "마감된 순서(최신 마감 우선)" 정렬
      closed = closed
        .slice()
        .sort((a,b)=>{
          const ta = new Date(a.closedAt || a.endTime).getTime();
          const tb = new Date(b.closedAt || b.endTime).getTime();
          return tb - ta; // 최신이 위
        })
        .slice(0, UI_LIMITS.MAX_CLOSED_SHOW);

      if(open.length===0){
        openGrid.innerHTML = `<div class="smallText" style="padding:18px;">진행중 경매가 없습니다.</div>`;
      }else{
        open.forEach(p=> openGrid.appendChild(renderCard(p)));
      }

      const closedSection = document.getElementById("closedSection");
      if(closed.length === 0){
        closedSection.style.display = "none";
      }else{
        closedSection.style.display = "block";
        closed.forEach(p=> closedGrid.appendChild(renderCard(p)));
      }

      const openAll = visible.filter(p=>!p.closed);
      renderSummary(openAll);

      updateNextBidLabels();
    }

    /***********************
     * Tick
     ***********************/
    function tick(){
      let changed = false;

      state.products.forEach(p=>{
        const end = new Date(p.endTime).getTime();
        const wasClosed = !!p.closed;

        if(!isNaN(end) && end <= Date.now()){
          p.closed = true;
          onCloseFinalize(p);
        }

        if(p.closed){
          const beforeDefault = p.defaulted;
          applyDefault(p);
          maybeRefund(p);
          archiveFinishedClosed(p);
          if(beforeDefault !== p.defaulted) changed = true;
        }

        if(wasClosed !== p.closed) changed = true;

        // 진행중 카운트다운
        const cd = document.getElementById("cd_"+p.id);
        if(cd && !p.closed){
          cd.textContent = calcRemain(p.endTime).text;
        }

        // 하단 요약 카운트다운
        const sumCd = document.getElementById("sum_cd_"+p.id);
        if(sumCd && !p.closed){
          sumCd.textContent = calcRemain(p.endTime).text;
        }

        // 마감 카드 결제기한
        const dueEl = document.getElementById("due_"+p.id);
        if(dueEl && p.closed && p.payDueAt && !p.buyerPaid && !p.defaulted && p.winnerNick){
          const due = calcRemainFromMs(p.payDueAt);
          dueEl.textContent = due.over ? "기한 만료" : due.text;
        }
      });

      if(changed){
        saveProducts();
        renderAll();
      }
    }

    /***********************
     * Reset
     ***********************/
    function resetToSample(){
      if(!confirm("샘플 데이터로 초기화할까요? (현재 저장된 상품/입찰정보가 사라집니다)")) return;
      localStorage.removeItem(LS_KEY_NEW);
      localStorage.removeItem(LS_KEY_PREV);
      localStorage.removeItem(LS_KEY_OLD);
      localStorage.removeItem(LS_USERS);
      localStorage.removeItem(LS_LEDGER);
      init(true);
    }

    /***********************
     * Init
     ***********************/
    function init(forceSeed=false){
      loadFilter();

      document.getElementById("depositAccountText").textContent =
        `${DEPOSIT_ACCOUNT.bank} ${DEPOSIT_ACCOUNT.number} (예금주: ${DEPOSIT_ACCOUNT.name}) / 보증금: ${formatMoney(RULES.depositAmount)}원`;

      const loaded = forceSeed ? null : loadProducts();
      if(loaded && loaded.length){
        state.products = loaded.map(normalizeProduct);
      }else{
        state.products = seedSample();
      }

      saveProducts();
      syncClosedFlags();
      renderAll();

      document.getElementById("incSelect").addEventListener("change", updateNextBidLabels);
    }

    init(false);
    setInterval(tick, 1000);
  </script>
</body>
</html>
</html>
